generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
  binaryTargets   = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["auth"]
}

model User {
  id                  String               @id @default(uuid()) @db.Uuid
  email               String               @unique
  username            String               @unique
  password            String
  firstName           String?
  lastName            String?
  isActive            Boolean              @default(true)
  emailVerified       Boolean              @default(false)
  lastLoginAt         DateTime?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  role                Role                 @default(USER)
  mustChangePassword  Boolean              @default(false)
  auditLogs           AuditLog[]
  passwordResetTokens PasswordResetToken[]
  refreshTokens       RefreshToken[]

  @@map("users")
  @@schema("auth")
}

model RefreshToken {
  id         String    @id @default(uuid()) @db.Uuid
  userId     String    @db.Uuid
  token      String    @unique
  family     String
  deviceInfo String?
  ipAddress  String?
  userAgent  String?
  issuedAt   DateTime  @default(now())
  expiresAt  DateTime
  revokedAt  DateTime?
  revokedBy  String?   @db.Uuid
  reused     Boolean   @default(false)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
  @@schema("auth")
}

model PasswordResetToken {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @db.Uuid
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  ipAddress String?
  userAgent String?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
  @@schema("auth")
}

model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String?  @db.Uuid
  action     String
  resource   String?
  resourceId String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])

  @@map("audit_logs")
  @@schema("auth")
}

model api_clients {
  client_id     BigInt     @id @default(autoincrement())
  name          String
  contact_email String?
  created_at    DateTime   @default(now())
  is_active     Boolean    @default(true)
  keys          api_keys[]

  @@map("api_clients")
  @@schema("auth")
}

model api_keys {
  key_id       BigInt      @id @default(autoincrement())
  client_id    BigInt
  api_key_hash String
  scope        String?     @default("read:forecast")
  created_at   DateTime    @default(now())
  revoked_at   DateTime?
  client       api_clients @relation(fields: [client_id], references: [client_id], onDelete: Cascade)

  @@unique([client_id, api_key_hash])
  @@map("api_keys")
  @@schema("auth")
}

enum Role {
  ADMIN
  USER

  @@schema("auth")
}
